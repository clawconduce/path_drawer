<head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="/static/anytime.5.0.5.js"></script>
<link rel="stylesheet" type="text/css" href="static/anytime.5.0.5.css">

<script src="static/jquery.liblink.js"></script>
<script src="static/jquery.nouislider.js"></script>
<link rel="stylesheet" type="text/css" href="static/jquery.nouislider.css">

<script src="static/FileSaver.js"></script>
<style>
.float {
    float: left;
}
</style>

<script>
$(function() {
    var $img_obj = null;
    var paths = [];
    var path_time_bounds = [];
    var last_path = null;
    var start_time = null;
    var bltr = null;
    var img_w = null;
    var img_h = null;
    var canvas = $('#canvas')[0];
    var ctx = canvas.getContext('2d');
    //this could probably be done better, but right now
    //this is to make the canvas fit in the page nicely
    ctx.canvas.width  = window.innerWidth*0.75;
    ctx.canvas.height = window.innerHeight-40;


    //create a slider for selecting duration of a path
    $('#path-props').hide();
    $('#slider').noUiSlider({
        start: [ 0, 600 ],
        connect: true,
        range: {
            'min': 0,
            'max': 3600
        }
    });
    $('#slider').Link('upper').to($('#end'));
    $('#slider').Link('lower').to($('#start'));


    //setup datetime - could merge into 1, but that looks ugly
    AnyTime.picker( "seldate", { format: "%m/%d/%Z" } );
    $("#seltime").AnyTime_picker( { format: "%H:%i" });

    //Set an input that sets the max time for time sliders
    $('#seldur').bind('input', function() { 
        // get the current value of the input field.
        set_max_range( parseFloat($(this).val()) );
    });
    function set_max_range(max_range) {
        $('#slider').noUiSlider({range:{min:0, max:max_range} }, true);
    }



    $('#file-input').change(function(e) {
        var file = e.target.files[0];

        var imageType = /image.*/;
        if (!file.type.match(imageType))
            return;

        var reader = new FileReader();
        reader.onload = fileOnload;
        reader.readAsDataURL(file);
    });

    $('#coords-input').change(function(e) {
        var file = e.target.files[0];

        if (!file.type.match('application/json'))
            return;

        var reader = new FileReader();
        reader.onload = function(e) {
            var bltr_data = JSON.parse(e.target.result);
            if ((bltr_data['bl'].length == 2) && (bltr_data['tr'].length == 2)) {
                bltr = bltr_data
            }
        }
        reader.readAsText(file);
    });

    $('#import-input').change(function(e) {
        var file = e.target.files[0];

        if (!file.type.match('application/json'))
            return;

        var reader = new FileReader();
        reader.onload = function(e) {
            var imported_data = JSON.parse(e.target.result);
            if (imported_data.hasOwnProperty('data') &&
                imported_data.hasOwnProperty('times') &&
                imported_data.hasOwnProperty('bltr') &&
                imported_data.hasOwnProperty('duration') &&
                imported_data.hasOwnProperty('date') &&
                imported_data.hasOwnProperty('time')
                    ){
                if (imported_data['times'].length != imported_data['data'].length) {
                    console.log(imported_data['times']);
                    console.log(imported_data['times'].length);
                    console.log(imported_data['data']);
                    console.log(imported_data['data'].length);
                    alert('Data and times are not in sync');
                    return false;
                }
                $("#seldate")[0].value = imported_data['date'];
                $("#seltime")[0].value = imported_data['time'];
                bltr = imported_data['bltr'];
                set_max_range(imported_data['duration']);
                path_time_bounds = imported_data['times'];
                for (var j =0; j<imported_data['data'].length; j++){
                    save_path(imported_data['data'][j]);
                }
            }
        }
        reader.readAsText(file);
    });

    function draw_img_on_canvas(){
        var ctx = canvas.getContext('2d');
        //scale the image
        var height = $img_obj.height;
        var width = $img_obj.width;
        var cap_size = ctx.canvas.width*0.75;
        if (width > cap_size) {
            var ratio = width/cap_size;
            img_w = cap_size;
            img_h = height/ratio;
        } else {
            img_w = width;
            img_h = height;
        }
        ctx.canvas.height = img_h;
        ctx.drawImage($img_obj, 0, 0, img_w, img_h);
    }

    function draw_img($img){
        $img.load(function() {
            $img_obj= this;
            draw_img_on_canvas();
            add_click_listen();
        });
    }

    function show_path_props(path_ind){
        $('#path-name').text('path_'+path_ind);
        if (path_time_bounds[path_ind] !== null) {
            $("#slider").val(path_time_bounds[path_ind]);
        } else {
            $("#slider").val([0, 600]);
        }
        $('#path-props').show();
    }

    $('#paths').change(function() {
        var val = $("#paths option:selected");
        //draw the previously stored lines
        draw_img_on_canvas();
        var ctx = canvas.getContext('2d');
        if (val.length == 1) {
            show_path_props(val[0].value);
        } else {
            $('#path-props').hide();
        }
        for (i = 0; i<val.length; i++) {
            var path_ind = val[i].value;
            var my_path = paths[path_ind-1];
            ctx.beginPath();
            ctx.moveTo(my_path[0][1], my_path[0][2]);
            for (j = 1; j < my_path.length; j++) {
                ctx.lineTo(my_path[j][1], my_path[j][2]);
                ctx.stroke()
            }
        }
    });

    function save_path(new_path) {
        //save the path that was being drawn
        paths.push(new_path);
        path_time_bounds.push(null);
        $('#paths')
             .append($("<option></option>")
             .attr("value", paths.length)
             .text('path_'+paths.length)); 
        if (paths.length >= 5) {
            $('#paths').attr('size', paths.length);
        }
        show_path_props(paths.length);
    }

    function save_current_path(){
        if (last_path != null) {
            save_path(last_path);
        }
        start_time = null;
        last_path = null;
    }

    function add_scaled_point(dt, x, y) {
        if (bltr) {
            //scale the points
            ref_h = bltr['tr'][0] - bltr['bl'][0];
            ref_w = bltr['tr'][1] - bltr['bl'][1];
            var scaled_x = (x / img_w) * ref_w;
            var scaled_y = (y / img_h) * ref_h;
            last_path.push([dt, scaled_x, scaled_y]);
        } else {
            last_path.push([dt, x, y]);
        }
    }

    function add_click_listen() {
        save_current_path();
        touchDown = function(event, event1){
            start_time = Date.now();
            draw_img_on_canvas();
            //why did i have event1? maybe for touch (it's been a while)
            if (event1 !== undefined) {
                event.pageX = event1.pageX;
                event.pageY = event1.pageY;
            }
            var absolute = $(this).offset();
            var x = event.pageX - absolute.left;
            var y = event.pageY - absolute.top;
            last_path = [];
            last_path.push([0, x, y]);
            var ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        touchMove = function(event) {
            if (last_path!=null) {
                var absolute = $(this).offset();
                var x = event.pageX - absolute.left;
                var y = event.pageY - absolute.top;
                var dt = Date.now() - start_time;
                last_path.push([dt, x, y]);
                var ctx = canvas.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        }
        touchUp = function(event) {
            save_current_path();
        }
        $(canvas).mousedown(touchDown);
        $(canvas).mousemove(touchMove);
        $(canvas).mouseup(touchUp);
        //$(canvas).mouseleave(touchUp);
    }

    function fileOnload(e) {
        var img_data = e.target.result;
        var $img = $('<img>', { src: img_data });
        draw_img($img);
    }

    $('#unset-props').click(function(){
        var prop_ind = parseInt($('#path-name').text().substring(5));
        path_time_bounds[prop_ind] = null;
    });
    $('#set-props').click(function(){
        var prop_ind = parseInt($('#path-name').text().substring(5));
        path_time_bounds[prop_ind] = $("#slider").val();
    });

    $('#export').click(function (){
        var date_str = $("#seldate")[0].value;
        var time_str = $("#seltime")[0].value;
        var defaultConv = new AnyTime.Converter({utcFormatOffsetImposed: 0, format: "%m/%d/%Z %H:%i"});
        var epoch_time = defaultConv.parse(date_str+' '+time_str).getTime()/1000.0;
        var info = {
            'date': date_str,
            'time': time_str,
            'epoch': epoch_time,
            'duration': parseFloat($('#seldur').val()),
            'bltr': bltr,
            'data': paths,
            'times': path_time_bounds,
        };
        var blob = new Blob([JSON.stringify(info)], {type: "application/json;charset=utf-8"});
        saveAs(blob);
    });
});
</script>
</head>


<body>

<div class="float">
<canvas id="canvas" width="520px" height="520px"></canvas>
</div>
<div class="float">

Paths:<br>
<select size="5" id="paths" multiple="yes" > 
</select>
<br><br><br>

Map: <input type="file" id="file-input"><br>
Coords: <input type="file" id="coords-input"><br>
Import: <input type="file" id="import-input"><br>
<button id="export" type="button">Export</button>
<br><br><br>

Base Date: <input type="text" id="seldate" value="07/30/2014" /><br>
Base Time: <input type="text" id="seltime" value="12:34" /><br>
Max Path End: <input type="text" id="seldur" value=3600 /><br>



<br><br><br>
<div id="path-props">
    <h2><p id='path-name'></p></h2>
    <button id="unset-props" type="button">Unset Time</button><br><br>
    <div id="slider" class="slider"></div>
    <input id="start" name="start" class="inputs">
    <input id="end" name="end" class="inputs"><br>
    <button id="set-props" type="button">Save Time</button>
</div>


</div>

</body>

